<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Games - Clash of the Barbarians 2026</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #0f172a; 
            color: white; 
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
        }
        button { 
            padding: 15px 30px; 
            background: #3b82f6; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 16px; 
            margin: 10px; 
        }
        button:hover { 
            background: #2563eb; 
        }
        .log { 
            background: #1e293b; 
            padding: 20px; 
            border-radius: 8px; 
            margin-top: 20px; 
            height: 500px; 
            overflow-y: auto; 
            font-family: monospace; 
            font-size: 12px;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .info { color: #06b6d4; }
        .warning { color: #f59e0b; }
    </style>
</head>
<body>
    <div class="container">
        <h1>West Valley Basketball League - Phase 1.4</h1>
        <h2>Update Games Collection with Cross-Division Fields</h2>
        
        <div>
            <button onclick="analyzeGames()">Analyze Existing Games</button>
            <button onclick="updateGamesCollection()">Update Games Collection</button>
            <button onclick="verifyGamesUpdate()">Verify Games Update</button>
            <button onclick="clearLog()">Clear Log</button>
        </div>
        
        <div id="log" class="log">
            <div class="info">Ready to analyze and update games collection...</div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA4QaqS8c0Yl3SlpaCgxA9PxvWAkg3cKRg",
            authDomain: "az-flight-fall-league---2026.firebaseapp.com",
            projectId: "az-flight-fall-league---2026",
            storageBucket: "az-flight-fall-league---2026.firebasestorage.app",
            messagingSenderId: "370360541933",
            appId: "1:370360541933:web:53e7f2f4f70bd2b1bcf7a5"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        let teamsCache = {};
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div class="${type}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '<div class="info">Log cleared...</div>';
        }
        
        async function loadTeamsCache() {
            log('üìö Loading teams cache for reference...', 'info');
            
            try {
                const snapshot = await db.collection('teams').get();
                teamsCache = {};
                
                snapshot.forEach(doc => {
                    const team = doc.data();
                    teamsCache[doc.id] = {
                        name: team.name || team.fullName,
                        primaryDivision: team.primaryDivision || team.division,
                        organizationId: team.organizationId
                    };
                });
                
                log(`‚úÖ Loaded ${Object.keys(teamsCache).length} teams into cache`, 'success');
                
            } catch (error) {
                log(`‚ùå Error loading teams cache: ${error.message}`, 'error');
                throw error;
            }
        }
        
        async function analyzeGames() {
            log('üéÆ Analyzing existing games collection...', 'info');
            
            try {
                await loadTeamsCache();
                
                const snapshot = await db.collection('games').get();
                
                if (snapshot.empty) {
                    log('‚ö†Ô∏è No games found in database!', 'warning');
                    return;
                }
                
                log(`üìã Found ${snapshot.size} games:`, 'info');
                
                let withCrossDivision = 0;
                let withCountsForStandings = 0;
                let withAffectedDivisions = 0;
                let potentialCrossDivisionGames = 0;
                
                snapshot.forEach(doc => {
                    const game = doc.data();
                    const gameId = doc.id;
                    
                    // Check existing fields
                    if (typeof game.isCrossDivision !== 'undefined') withCrossDivision++;
                    if (game.countsForStandings) withCountsForStandings++;
                    if (game.affectedDivisions && Array.isArray(game.affectedDivisions)) withAffectedDivisions++;
                    
                    // Analyze if this is a cross-division game
                    const homeTeam = teamsCache[game.homeTeamId];
                    const awayTeam = teamsCache[game.awayTeamId];
                    
                    if (homeTeam && awayTeam && homeTeam.primaryDivision !== awayTeam.primaryDivision) {
                        potentialCrossDivisionGames++;
                        log(`  üîÑ Cross-division: ${homeTeam.name} (${homeTeam.primaryDivision}) vs ${awayTeam.name} (${awayTeam.primaryDivision})`, 'warning');
                    }
                    
                    // Log game details
                    const homeTeamName = homeTeam ? homeTeam.name : game.homeTeam || 'Unknown';
                    const awayTeamName = awayTeam ? awayTeam.name : game.awayTeam || 'Unknown';
                    const homeDivision = homeTeam ? homeTeam.primaryDivision : 'Unknown';
                    const awayDivision = awayTeam ? awayTeam.primaryDivision : 'Unknown';
                    
                    log(`  üìÖ ${homeTeamName} vs ${awayTeamName} | Status: ${game.status || 'Unknown'} | Divisions: ${homeDivision} vs ${awayDivision}`, 'info');
                });
                
                log(`üìä AnaBarbarian Sportsis Summary:`, 'info');
                log(`  ‚Ä¢ Total games: ${snapshot.size}`, 'info');
                log(`  ‚Ä¢ With isCrossDivision field: ${withCrossDivision}`, withCrossDivision === snapshot.size ? 'success' : 'warning');
                log(`  ‚Ä¢ With countsForStandings field: ${withCountsForStandings}`, withCountsForStandings === snapshot.size ? 'success' : 'warning');
                log(`  ‚Ä¢ With affectedDivisions field: ${withAffectedDivisions}`, withAffectedDivisions === snapshot.size ? 'success' : 'warning');
                log(`  ‚Ä¢ Potential cross-division games: ${potentialCrossDivisionGames}`, potentialCrossDivisionGames > 0 ? 'warning' : 'info');
                
                if (withCrossDivision === snapshot.size && withCountsForStandings === snapshot.size && withAffectedDivisions === snapshot.size) {
                    log('‚úÖ All games already have cross-division fields!', 'success');
                } else {
                    log('‚ö†Ô∏è Games need to be updated with cross-division fields', 'warning');
                }
                
            } catch (error) {
                log(`‚ùå AnaBarbarian Sportsis failed: ${error.message}`, 'error');
            }
        }
        
        async function updateGamesCollection() {
            log('üîÑ Starting games collection update...', 'info');
            
            try {
                await loadTeamsCache();
                
                const snapshot = await db.collection('games').get();
                
                if (snapshot.empty) {
                    log('‚ùå No games found to update!', 'error');
                    return;
                }
                
                log(`üìù Updating ${snapshot.size} games...`, 'info');
                
                let updated = 0;
                let errors = 0;
                let crossDivisionCount = 0;
                
                for (const doc of snapshot.docs) {
                    const game = doc.data();
                    const gameId = doc.id;
                    
                    try {
                        // Get team information
                        const homeTeam = teamsCache[game.homeTeamId];
                        const awayTeam = teamsCache[game.awayTeamId];
                        
                        if (!homeTeam || !awayTeam) {
                            log(`‚ö†Ô∏è Missing team data for game ${gameId} - skipping`, 'warning');
                            continue;
                        }
                        
                        // Determine cross-division status
                        const isCrossDivision = homeTeam.primaryDivision !== awayTeam.primaryDivision;
                        
                        // Counts for home team's division (as per master prompt)
                        const countsForStandings = homeTeam.primaryDivision;
                        
                        // Show in both divisions if cross-division
                        const affectedDivisions = isCrossDivision 
                            ? [homeTeam.primaryDivision, awayTeam.primaryDivision]
                            : [homeTeam.primaryDivision];
                        
                        // Prepare update data
                        const updateData = {
                            isCrossDivision: isCrossDivision,
                            countsForStandings: countsForStandings,
                            affectedDivisions: affectedDivisions
                        };
                        
                        // Update the game document
                        await db.collection('games').doc(gameId).update(updateData);
                        
                        if (isCrossDivision) {
                            crossDivisionCount++;
                            log(`‚úÖ Updated cross-division game: ${homeTeam.name} (${homeTeam.primaryDivision}) vs ${awayTeam.name} (${awayTeam.primaryDivision})`, 'warning');
                        } else {
                            log(`‚úÖ Updated same-division game: ${homeTeam.name} vs ${awayTeam.name} (${homeTeam.primaryDivision})`, 'success');
                        }
                        
                        updated++;
                        
                    } catch (error) {
                        log(`‚ùå Error updating game ${gameId}: ${error.message}`, 'error');
                        errors++;
                    }
                }
                
                log(`üéâ Update complete!`, 'success');
                log(`  ‚Ä¢ Games updated: ${updated}`, 'success');
                log(`  ‚Ä¢ Cross-division games: ${crossDivisionCount}`, 'warning');
                log(`  ‚Ä¢ Errors: ${errors}`, errors > 0 ? 'error' : 'success');
                
            } catch (error) {
                log(`‚ùå Update failed: ${error.message}`, 'error');
            }
        }
        
        async function verifyGamesUpdate() {
            log('üîç Verifying games update...', 'info');
            
            try {
                const snapshot = await db.collection('games').get();
                
                if (snapshot.empty) {
                    log('‚ùå No games found!', 'error');
                    return;
                }
                
                let withIsCrossDivision = 0;
                let withCountsForStandings = 0;
                let withAffectedDivisions = 0;
                let crossDivisionGames = 0;
                let sameDivisionGames = 0;
                
                snapshot.forEach(doc => {
                    const game = doc.data();
                    
                    // Check required fields
                    if (typeof game.isCrossDivision === 'boolean') withIsCrossDivision++;
                    if (game.countsForStandings) withCountsForStandings++;
                    if (game.affectedDivisions && Array.isArray(game.affectedDivisions)) withAffectedDivisions++;
                    
                    // Count cross-division vs same-division
                    if (game.isCrossDivision === true) {
                        crossDivisionGames++;
                    } else if (game.isCrossDivision === false) {
                        sameDivisionGames++;
                    }
                });
                
                log(`üìä Verification Summary:`, 'info');
                log(`  ‚Ä¢ Total games: ${snapshot.size}`, 'info');
                log(`  ‚Ä¢ With isCrossDivision field: ${withIsCrossDivision}`, withIsCrossDivision === snapshot.size ? 'success' : 'error');
                log(`  ‚Ä¢ With countsForStandings field: ${withCountsForStandings}`, withCountsForStandings === snapshot.size ? 'success' : 'error');
                log(`  ‚Ä¢ With affectedDivisions field: ${withAffectedDivisions}`, withAffectedDivisions === snapshot.size ? 'success' : 'error');
                log(`  ‚Ä¢ Cross-division games: ${crossDivisionGames}`, 'warning');
                log(`  ‚Ä¢ Same-division games: ${sameDivisionGames}`, 'info');
                
                // Detailed verification
                snapshot.forEach(doc => {
                    const game = doc.data();
                    const gameId = doc.id;
                    
                    log(`üìã Game ${gameId}:`, 'info');
                    log(`    isCrossDivision: ${game.isCrossDivision}`, 'info');
                    log(`    countsForStandings: ${game.countsForStandings}`, 'info');
                    log(`    affectedDivisions: [${(game.affectedDivisions || []).join(', ')}]`, 'info');
                });
                
                if (withIsCrossDivision === snapshot.size && withCountsForStandings === snapshot.size && withAffectedDivisions === snapshot.size) {
                    log('‚úÖ Phase 1.4 COMPLETE: All games have cross-division fields!', 'success');
                } else {
                    log('‚ö†Ô∏è Some games missing required fields', 'warning');
                }
                
            } catch (error) {
                log(`‚ùå Verification failed: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
